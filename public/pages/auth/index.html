<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/assets/images/oslira-logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Oslira</title>
    <script src="/core/script-loader.js"></script>
    
    <link rel="stylesheet" href="/pages/auth/auth.css">
    <style>
        /* Tab Interface Styles */
        .auth-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-light);
            margin-bottom: var(--spacing-6);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: var(--spacing-4);
            background: var(--bg-secondary);
            border: none;
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-base);
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-bottom-color: var(--primary-blue);
        }

        .tab-button:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Google Button Styles */
        .google-button {
            width: 100%;
            height: var(--button-height-lg);
            padding: 0 var(--button-padding-x-lg);
            background: #ffffff;
            color: #1f1f1f;
            border: 1px solid #dadce0;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }

        .google-button:hover:not(:disabled) {
            background: #f8f9fa;
            box-shadow: 0 1px 6px 0 rgba(32,33,36,.28);
        }

        .google-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* Password Toggle */
        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: var(--text-sm);
            padding: 4px;
        }

        .password-toggle:hover {
            color: var(--text-primary);
        }

        /* Divider */
        .divider {
            position: relative;
            text-align: center;
            margin: var(--spacing-6) 0;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-light);
        }

        .divider-text {
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            padding: 0 var(--spacing-4);
        }

        /* Form Options */
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: var(--spacing-4) 0;
            font-size: var(--text-sm);
        }

        .optional-field {
            opacity: 0.7;
        }

        .optional-field label::after {
            content: " (optional)";
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        /* Phone OTP Flow */
        .otp-field {
            display: none;
            margin-top: var(--spacing-4);
        }

        .otp-field.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-nav">Skip to main content</a>
    
    <div class="auth-container" id="main-content">
        <div class="auth-card" id="main-card">
            <div class="auth-header">
                <div class="logo">
                    <img src="/assets/images/oslira-logo.png" alt="Oslira Logo" class="logo-image">
                    <h1>Oslira</h1>
                </div>
                <div class="auth-subtitle">AI-Powered Lead Generation</div>
                <div class="auth-description">
                    Sign in or create your account to start analyzing leads and generating personalized outreach.
                </div>
            </div>

            <div class="error-message" id="error-display" role="alert" aria-live="polite">
                <!-- Error messages will appear here -->
            </div>

            <!-- Tab Navigation -->
            <div class="auth-tabs">
                <button class="tab-button active" data-tab="signin">Sign In</button>
                <button class="tab-button" data-tab="signup">Sign Up</button>
            </div>

            <!-- Sign In Tab -->
            <div class="tab-content active" id="signin-tab">
                <!-- Google Sign In -->
                <button class="google-button" id="google-signin-btn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>

                <div class="divider">
                    <span class="divider-text">or</span>
                </div>

                <!-- Email/Password Sign In Form -->
                <form class="auth-form" id="signin-form">
                    <div class="form-group">
                        <label class="form-label" for="signin-email">Email or Username</label>
                        <input 
                            type="text" 
                            id="signin-email" 
                            class="form-input" 
                            placeholder="email@example.com or username"
                            autocomplete="username"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signin-password">Password</label>
                        <div class="password-field">
                            <input 
                                type="password" 
                                id="signin-password" 
                                class="form-input" 
                                placeholder="Enter your password"
                                autocomplete="current-password"
                                required
                            >
                            <button type="button" class="password-toggle" data-target="signin-password">
                                Show
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="auth-button" id="signin-submit">
                        Sign In
                    </button>
                </form>

                <!-- Phone Sign In Option -->
                <div class="divider">
                    <span class="divider-text">or</span>
                </div>
                
                <form class="auth-form" id="phone-signin-form">
                    <div class="form-group">
                        <label class="form-label" for="signin-phone">Phone Number</label>
                        <input 
                            type="tel" 
                            id="signin-phone" 
                            class="form-input" 
                            placeholder="+1 (555) 123-4567"
                            autocomplete="tel"
                        >
                        <div class="form-help">We'll send you a verification code</div>
                    </div>

                    <div class="form-group otp-field" id="signin-otp-field">
                        <label class="form-label" for="signin-otp">Verification Code</label>
                        <input 
                            type="text" 
                            id="signin-otp" 
                            class="form-input" 
                            placeholder="Enter 6-digit code"
                            maxlength="6"
                        >
                    </div>

                    <button type="submit" class="auth-button" id="phone-signin-submit">
                        Send Code
                    </button>
                </form>
            </div>

            <!-- Sign Up Tab -->
            <div class="tab-content" id="signup-tab">
                <!-- Google Sign Up -->
                <button class="google-button" id="google-signup-btn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Create Account with Google
                </button>

                <div class="divider">
                    <span class="divider-text">or</span>
                </div>

                <!-- Email/Password Sign Up Form -->
                <form class="auth-form" id="signup-form">
                    <div class="form-group">
                        <label class="form-label" for="signup-email">Email Address</label>
                        <input 
                            type="email" 
                            id="signup-email" 
                            class="form-input" 
                            placeholder="email@example.com"
                            autocomplete="email"
                            required
                        >
                    </div>

                    <div class="form-group optional-field">
                        <label class="form-label" for="signup-fullname">Full Name</label>
                        <input 
                            type="text" 
                            id="signup-fullname" 
                            class="form-input" 
                            placeholder="John Doe"
                            autocomplete="name"
                        >
                    </div>

                    <div class="form-group optional-field">
                        <label class="form-label" for="signup-username">Username</label>
                        <input 
                            type="text" 
                            id="signup-username" 
                            class="form-input" 
                            placeholder="username"
                            autocomplete="username"
                        >
                        <div class="form-help">3-20 characters, letters, numbers, underscore, hyphen</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signup-password">Password</label>
                        <div class="password-field">
                            <input 
                                type="password" 
                                id="signup-password" 
                                class="form-input" 
                                placeholder="Create a password"
                                autocomplete="new-password"
                                minlength="8"
                                required
                            >
                            <button type="button" class="password-toggle" data-target="signup-password">
                                Show
                            </button>
                        </div>
                        <div class="form-help">Minimum 8 characters</div>
                    </div>

                    <div class="form-group optional-field">
                        <label class="form-label" for="signup-phone">Phone Number</label>
                        <input 
                            type="tel" 
                            id="signup-phone" 
                            class="form-input" 
                            placeholder="+1 (555) 123-4567"
                            autocomplete="tel"
                        >
                        <div class="form-help">For account security and notifications</div>
                    </div>

                    <button type="submit" class="auth-button" id="signup-submit">
                        Create Account
                    </button>
                </form>
            </div>

            <div class="auth-footer">
                <p class="auth-note">
                    By continuing, you agree to our Terms of Service and Privacy Policy.
                </p>
                <p class="auth-links">
                    <a href="/">← Back to Home</a>
                    <span class="separator">•</span>
                    <a href="/privacy.html">Privacy Policy</a>
                    <span class="separator">•</span>
                    <a href="/terms.html">Terms</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Clear error messages
                hideError();
            });
        });

        // Password toggle functionality
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.dataset.target;
                const input = document.getElementById(targetId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.textContent = 'Hide';
                } else {
                    input.type = 'password';
                    toggle.textContent = 'Show';
                }
            });
        });

        // Error message handling
        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            const errorDiv = document.getElementById('error-display');
            errorDiv.classList.remove('show');
        }

        // Phone OTP flow
        let phoneOtpSent = false;
        let currentPhone = '';

        document.getElementById('phone-signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phoneInput = document.getElementById('signin-phone');
            const otpInput = document.getElementById('signin-otp');
            const submitBtn = document.getElementById('phone-signin-submit');
            const otpField = document.getElementById('signin-otp-field');
            
            if (!phoneOtpSent) {
                // Send OTP
                const phone = phoneInput.value.trim();
                if (!phone) {
                    showError('Please enter your phone number');
                    return;
                }
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Sending Code...';
                    
                    const authSystem = await waitForAuthSystem();
                    const auth = await authSystem.initialize();
                    await auth.signInWithPhone(phone);
                    
                    currentPhone = phone;
                    phoneOtpSent = true;
                    otpField.classList.add('show');
                    submitBtn.textContent = 'Verify Code';
                    phoneInput.disabled = true;
                    otpInput.focus();
                    
                } catch (error) {
                    showError(error.message);
                } finally {
                    submitBtn.disabled = false;
                }
            } else {
                // Verify OTP
                const otp = otpInput.value.trim();
                if (!otp) {
                    showError('Please enter the verification code');
                    return;
                }
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Verifying...';
                    
                    const authSystem = await waitForAuthSystem();
                    const auth = await authSystem.initialize();
                    await auth.verifyPhoneOtp(currentPhone, otp);
                    
                    // Success - will be handled by auth state change
                    
                } catch (error) {
                    showError(error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Verify Code';
                }
            }
        });

        // Google OAuth handlers
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            try {
                const authSystem = await waitForAuthSystem();
                const auth = await authSystem.initialize();
                await auth.signInWithGoogle();
            } catch (error) {
                showError(error.message);
            }
        });

        document.getElementById('google-signup-btn').addEventListener('click', async () => {
            try {
                const authSystem = await waitForAuthSystem();
                const auth = await authSystem.initialize();
                await auth.signInWithGoogle();
            } catch (error) {
                showError(error.message);
            }
        });

        // Email/Password Sign In
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            const submitBtn = document.getElementById('signin-submit');
            
            if (!email || !password) {
                showError('Please enter both email/username and password');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Signing In...';
                
                const authSystem = await waitForAuthSystem();
                const auth = await authSystem.initialize();
                
                // Try email first, then username if it fails
                if (email.includes('@')) {
                    await auth.signInWithPassword(email, password);
                } else {
                    await auth.signInWithUsername(email, password);
                }
                
                // Success - will be handled by auth state change
                
            } catch (error) {
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
            }
        });

        // Email/Password Sign Up
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const fullName = document.getElementById('signup-fullname').value.trim();
            const username = document.getElementById('signup-username').value.trim();
            const phone = document.getElementById('signup-phone').value.trim();
            const submitBtn = document.getElementById('signup-submit');
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Account...';
                
                const authSystem = await waitForAuthSystem();
                const auth = await authSystem.initialize();
                
                // Check username availability if provided
                if (username) {
                    const available = await auth.checkUsernameAvailable(username);
                    if (!available) {
                        showError('Username is already taken');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create Account';
                        return;
                    }
                }
                
                const result = await auth.signUpWithPassword(email, password, {
                    fullName,
                    username,
                    phone
                });
                
                if (result.needsEmailConfirmation) {
                    showError('Please check your email and click the confirmation link');
                    submitBtn.textContent = 'Email Sent';
                }
                
            } catch (error) {
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        });

        // Auth state change handler - ENHANCED LOGGING
        window.addEventListener('auth:change', (event) => {
            const { session, user, event: authEvent } = event.detail;
            
            console.log('🔐 [Auth Page] Auth state changed:', {
                event: authEvent,
                authenticated: !!session,
                userId: user?.id,
                onboardingComplete: user?.onboarding_completed,
                userObject: user
            });
            
            if (session && user) {
                console.log('🔐 [Auth Page] User authenticated, determining redirect...');
                
                // Redirect based on onboarding status
                if (!user.onboarding_completed) {
                    console.log('🔐 [Auth Page] Redirecting to onboarding...');
                    window.location.href = '/onboarding';
                } else {
                    console.log('🔐 [Auth Page] Redirecting to dashboard...');
                    window.location.href = '/dashboard';
                }
            }
        });

        // Wait for auth system to be loaded, then initialize
        async function waitForAuthSystem() {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds
            
            while (attempts < maxAttempts) {
                if (window.OsliraAuth?.initialize) {
                    return window.OsliraAuth;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            throw new Error('Auth system not available after timeout');
        }

        // Initialize auth on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🔐 [Auth Page] Waiting for auth system...');
                const authSystem = await waitForAuthSystem();
                
                console.log('🔐 [Auth Page] Initializing auth system...');
                const auth = await authSystem.initialize();
                
                // Redirect if already authenticated
                console.log('🔐 [Auth Page] Checking if user is already authenticated...');
                const shouldShowForm = await auth.handleAuthPage();
                console.log('🔐 [Auth Page] Should show form:', shouldShowForm);
                
                if (!shouldShowForm) {
                    console.log('🔐 [Auth Page] Already authenticated, should redirect...');
                    return; // Will redirect
                }
                
                console.log('🔐 [Auth Page] Not authenticated, showing auth forms');
                
            } catch (error) {
                console.error('Auth initialization failed:', error);
                showError('Authentication system temporarily unavailable');
            }
        });
    </script>
</body>
</html>
