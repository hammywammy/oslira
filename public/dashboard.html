// app.js - Add this to your existing dashboard

const supabaseUrl = 'https://jswzzihuqtjqvobfosks.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impzd3p6aWh1cXRqcXZvYmZvc2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMjQxMzUsImV4cCI6MjA2NzYwMDEzNX0.XMoC3iLcDbKNxPfhTHj8CQsEjelTIrivIddfPTO9P64';

// Initialize Supabase client
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Replace with your actual Cloudflare Worker URL when deployed
const WORKER_URL = 'https://your-worker.example.workers.dev/analyze';

let currentUser = null;
let currentSession = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🚀 Dashboard loaded');
    await checkAuth();
    await loadDashboardData();
});

// Check authentication
async function checkAuth() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error || !session) {
            console.log('No session found, redirecting to auth...');
            window.location.href = 'auth.html';
            return;
        }
        
        currentSession = session;
        currentUser = session.user;
        
        console.log('✅ User authenticated:', currentUser.email);
        
        // Update UI with user info
        document.getElementById('user-email').textContent = currentUser.email;
        
    } catch (err) {
        console.error('Auth check error:', err);
        window.location.href = 'auth.html';
    }
}

// Load dashboard data
async function loadDashboardData() {
    await loadUserCredits();
    await loadRecentActivity();
    await loadStats();
}

// Load user credits
async function loadUserCredits() {
    try {
        const { data: userData, error } = await supabase
            .from('users')
            .select('credits')
            .eq('id', currentUser.id)
            .single();
        
        if (error) throw error;
        
        const credits = userData?.credits || 0;
        document.getElementById('credit-count').textContent = `${credits} credits`;
        
    } catch (err) {
        console.error('Error loading credits:', err);
        document.getElementById('credit-count').textContent = 'Error loading';
    }
}

// Load recent activity
async function loadRecentActivity() {
    try {
        const { data: leads, error } = await supabase
            .from('leads')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) throw error;
        
        const tableBody = document.getElementById('activity-table');
        if (leads && leads.length > 0) {
            tableBody.innerHTML = leads.map(lead => `
                <tr>
                    <td>${new Date(lead.created_at).toLocaleString()}</td>
                    <td>@${lead.profile_username || 'unknown'}</td>
                    <td><span class="score-badge">${lead.match_score || 0}</span></td>
                    <td><span class="status ${lead.status}">${lead.status}</span></td>
                    <td><button onclick="viewLead('${lead.id}')">View</button></td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = '<tr><td colspan="5">No recent activity</td></tr>';
        }
        
    } catch (err) {
        console.error('Error loading activity:', err);
    }
}

// Load stats
async function loadStats() {
    try {
        // Get total leads count
        const { count: totalLeads } = await supabase
            .from('leads')
            .select('*', { count: 'exact' })
            .eq('user_id', currentUser.id);
        
        // Get average score
        const { data: avgData } = await supabase
            .from('leads')
            .select('match_score')
            .eq('user_id', currentUser.id);
        
        const avgScore = avgData?.length > 0 
            ? Math.round(avgData.reduce((sum, lead) => sum + (lead.match_score || 0), 0) / avgData.length)
            : 0;
        
        // Update stats in UI
        document.querySelector('.stat-card:nth-child(1) .big-number').textContent = totalLeads || 0;
        document.querySelector('.stat-card:nth-child(2) .big-number').textContent = avgScore;
        
    } catch (err) {
        console.error('Error loading stats:', err);
    }
}

// Test analysis function (for Quick Actions)
async function testAnalysis() {
    const profileUrl = prompt('Enter Instagram profile URL to test:');
    if (!profileUrl) return;
    
    const analysisType = confirm('Deep analysis? (OK = Deep, Cancel = Light)') ? 'deep' : 'light';
    
    if (!currentSession?.access_token) {
        alert('No valid session. Please log in again.');
        return;
    }

    try {
        console.log('🔍 Testing analysis...', { profileUrl, analysisType });
        
        const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${currentSession.access_token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                profile_url: profileUrl,
                analysisType: analysisType
            })
        });

        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `Worker error: ${response.status}`);
        }

        console.log('✅ Analysis completed:', result);
        alert(`Analysis completed! Lead ID: ${result.lead_id}, Credits used: ${result.creditsUsed}`);
        
        // Refresh dashboard data
        await loadDashboardData();

    } catch (err) {
        console.error('❌ Analysis error:', err);
        alert('Analysis failed: ' + err.message);
    }
}

// Update the Research New Leads button to test analysis
document.addEventListener('DOMContentLoaded', () => {
    const researchBtn = document.querySelector('.primary-btn');
    if (researchBtn) {
        researchBtn.onclick = () => testAnalysis();
        researchBtn.textContent = 'Test Analysis';
    }
});

// Existing functions
function logout() {
    supabase.auth.signOut().then(() => {
        window.location.href = 'auth.html';
    });
}

function uploadCSV() {
    alert('CSV upload feature coming soon!');
}

function viewLead(leadId) {
    alert(`Viewing lead: ${leadId}`);
    // You can implement a modal or redirect to lead details page
}

// Listen for auth changes
supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event);
    
    if (event === 'SIGNED_OUT' || !session) {
        window.location.href = 'auth.html';
    }
});
