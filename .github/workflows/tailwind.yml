name: Build Tailwind CSS

on:
  push:
    branches: [main, staging]
    paths: 
      - 'src/**/*.css'
      - 'tailwind.config.js'
      - 'public/**/*.html'
      - 'public/**/*.js'
      - 'public/core/**/*.js'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Download Tailwind CSS Standalone
      run: |
        echo "ğŸ“¦ Downloading Tailwind CSS standalone binary..."
        curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
        chmod +x tailwindcss-linux-x64
        echo "âœ… Tailwind CSS binary downloaded and made executable"
        
    - name: Create output directory
      run: mkdir -p public/assets/css
    
    - name: Build Tailwind CSS with Component Classes
      run: |
        echo "ğŸ¨ Building Tailwind CSS with component classes..."
        
        # Build main CSS file with component classes using standalone binary
        ./tailwindcss-linux-x64 -i src/styles.css -o public/assets/css/tailwind.css --minify
        
        # Verify the file was created and contains component classes
        ls -la public/assets/css/
        echo "ğŸ“Š File size: $(du -h public/assets/css/tailwind.css)"
        
        # Check that component classes are included
        echo "ğŸ” Verifying component classes are included..."
        if grep -q "footer-main" public/assets/css/tailwind.css; then
          echo "âœ… Footer component classes found"
        else
          echo "âŒ Footer component classes missing"
          exit 1
        fi
        
        if grep -q "dashboard-card" public/assets/css/tailwind.css; then
          echo "âœ… Dashboard component classes found"
        else
          echo "âŒ Dashboard component classes missing"
          exit 1
        fi
        
        if grep -q "btn-primary" public/assets/css/tailwind.css; then
          echo "âœ… Button component classes found"
        else
          echo "âŒ Button component classes missing"
          exit 1
        fi
        
        echo "âœ… All component classes successfully built into CSS"
        
        # Show first few lines for debugging
        echo "ğŸ“ CSS file preview:"
        head -c 1000 public/assets/css/tailwind.css || echo "CSS file too large for preview"
    
    - name: Validate CSS Output
      run: |
        echo "ğŸ” Running CSS validation..."
        
        # Check file size (should be reasonable with component classes)
        FILE_SIZE=$(stat -c%s public/assets/css/tailwind.css)
        echo "ğŸ“Š Generated CSS size: $FILE_SIZE bytes"
        
        # Size should be reasonable (not too small, not too large)
        if [ $FILE_SIZE -lt 5000 ]; then
          echo "âš ï¸ CSS file seems too small, may be missing classes"
          exit 1
        fi
        
        if [ $FILE_SIZE -gt 500000 ]; then
          echo "âš ï¸ CSS file seems too large, may have unused classes"
          echo "ğŸ’¡ Consider reviewing content paths in tailwind.config.js"
        fi
        
        echo "âœ… CSS file size is within expected range"
    
    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add public/assets/css/tailwind.css
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git commit -m "Auto-build Tailwind CSS with component classes [skip ci]"
          git push origin ${{ github.ref_name }}
          echo "âœ… CSS changes committed and pushed"
        fi
    
    - name: Build Summary
      run: |
        echo "ğŸ‰ Tailwind CSS build completed successfully!"
        echo "ğŸ“ Output file: public/assets/css/tailwind.css"
        echo "ğŸ¨ Component classes: Included via @apply directives"
        echo "ğŸ”§ Build method: Standalone binary"
        echo "ğŸ“Š Final size: $(du -h public/assets/css/tailwind.css)"
        echo ""
        echo "ğŸš€ Deployment ready - modular CSS architecture activated"
        echo "âœ¨ Your monolithic CSS has been replaced with sustainable build"
