name: Build Tailwind CSS

on:
  push:
    branches: [main, staging]
    paths: 
      - 'src/styles.css'
      - 'tailwind.config.js'
      - 'public/**/*.html'
      - 'public/**/*.js'
      - 'public/core/**/*.js'  # Added to watch component files
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - run: npm install -D tailwindcss@latest
    
    - run: mkdir -p public/assets/css
    
    - name: Build Tailwind CSS with Component Classes
      run: |
        echo "ğŸ¨ Building Tailwind CSS with component classes..."
        
        # Build main CSS file with component classes
        npx tailwindcss -i src/styles.css -o public/assets/css/tailwind.css --minify --watch=false
        
        # Verify the file was created and contains component classes
        ls -la public/assets/css/
        echo "ğŸ“Š File size: $(du -h public/assets/css/tailwind.css)"
        
        # Check that component classes are included
        echo "ğŸ” Verifying component classes are included..."
        if grep -q "footer-main" public/assets/css/tailwind.css; then
          echo "âœ… Footer component classes found"
        else
          echo "âŒ Footer component classes missing"
          exit 1
        fi
        
        if grep -q "dashboard-card" public/assets/css/tailwind.css; then
          echo "âœ… Dashboard component classes found"
        else
          echo "âŒ Dashboard component classes missing"
          exit 1
        fi
        
        if grep -q "btn-primary" public/assets/css/tailwind.css; then
          echo "âœ… Button component classes found"
        else
          echo "âŒ Button component classes missing"
          exit 1
        fi
        
        echo "âœ… All component classes successfully built into CSS"
        
        # Show first few lines for debugging
        echo "ğŸ“ CSS file preview:"
        head -10 public/assets/css/tailwind.css
    
    - name: Validate CSS Output
      run: |
        echo "ğŸ” Running CSS validation..."
        
        # Check file size (should be reasonable with component classes)
        FILE_SIZE=$(stat -f%z public/assets/css/tailwind.css 2>/dev/null || stat -c%s public/assets/css/tailwind.css)
        echo "ğŸ“Š Generated CSS size: $FILE_SIZE bytes"
        
        # Size should be reasonable (not too small, not too large)
        if [ $FILE_SIZE -lt 10000 ]; then
          echo "âš ï¸ CSS file seems too small, may be missing classes"
          exit 1
        fi
        
        if [ $FILE_SIZE -gt 500000 ]; then
          echo "âš ï¸ CSS file seems too large, may have unused classes"
          echo "ğŸ’¡ Consider reviewing safelist in tailwind.config.js"
        fi
        
        echo "âœ… CSS file size is within expected range"
    
    - name: Commit changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add public/assets/css/tailwind.css
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git commit -m "Auto-build Tailwind CSS with component classes [skip ci]"
          git push
          echo "âœ… CSS changes committed and pushed"
        fi
    
    - name: Build Summary
      run: |
        echo "ğŸ‰ Tailwind CSS build completed successfully!"
        echo "ğŸ“ Output file: public/assets/css/tailwind.css"
        echo "ğŸ¨ Component classes: Included via @apply directives"
        echo "ğŸ”§ Build method: Component classes pattern"
        echo "ğŸ“Š Final size: $(du -h public/assets/css/tailwind.css)"
        echo ""
        echo "ğŸš€ Deployment ready - no safelist management required"
        echo "âœ¨ Infinite scalability - add components without config changes"
