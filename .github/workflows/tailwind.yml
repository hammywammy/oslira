name: Build Tailwind CSS

on:
  push:
    branches: [main, staging]
    paths: 
      - 'src/**/*.css'
      - 'tailwind.config.js'
      - 'public/**/*.html'
      - 'public/**/*.js'
      - 'public/core/**/*.js'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Download Tailwind CSS Standalone
      run: |
        echo "📦 Downloading Tailwind CSS standalone binary..."
        curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
        chmod +x tailwindcss-linux-x64
        echo "✅ Tailwind CSS binary downloaded and made executable"
        
    - name: Create output directory
      run: mkdir -p public/assets/css
    
    - name: Build Tailwind CSS with Component Classes
      run: |
        echo "🎨 Building Tailwind CSS with component classes..."
        
        # Build main CSS file with component classes using standalone binary
        ./tailwindcss-linux-x64 -i src/styles.css -o public/assets/css/tailwind.css --minify
        
        # Verify the file was created and contains component classes
        ls -la public/assets/css/
        echo "📊 File size: $(du -h public/assets/css/tailwind.css)"
        
        # Check that component classes are included
        echo "🔍 Verifying component classes are included..."
        if grep -q "footer-main" public/assets/css/tailwind.css; then
          echo "✅ Footer component classes found"
        else
          echo "❌ Footer component classes missing"
          exit 1
        fi
        
        if grep -q "dashboard-card" public/assets/css/tailwind.css; then
          echo "✅ Dashboard component classes found"
        else
          echo "❌ Dashboard component classes missing"
          exit 1
        fi
        
        if grep -q "btn-primary" public/assets/css/tailwind.css; then
          echo "✅ Button component classes found"
        else
          echo "❌ Button component classes missing"
          exit 1
        fi
        
        echo "✅ All component classes successfully built into CSS"
        
        # Show first few lines for debugging
        echo "📝 CSS file preview:"
        head -c 1000 public/assets/css/tailwind.css || echo "CSS file too large for preview"
    
    - name: Validate CSS Output
      run: |
        echo "🔍 Running CSS validation..."
        
        # Check file size (should be reasonable with component classes)
        FILE_SIZE=$(stat -c%s public/assets/css/tailwind.css)
        echo "📊 Generated CSS size: $FILE_SIZE bytes"
        
        # Size should be reasonable (not too small, not too large)
        if [ $FILE_SIZE -lt 5000 ]; then
          echo "⚠️ CSS file seems too small, may be missing classes"
          exit 1
        fi
        
        if [ $FILE_SIZE -gt 500000 ]; then
          echo "⚠️ CSS file seems too large, may have unused classes"
          echo "💡 Consider reviewing content paths in tailwind.config.js"
        fi
        
        echo "✅ CSS file size is within expected range"
    
    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add public/assets/css/tailwind.css
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "ℹ️ No changes to commit"
        else
          git commit -m "Auto-build Tailwind CSS with component classes [skip ci]"
          git push origin ${{ github.ref_name }}
          echo "✅ CSS changes committed and pushed"
        fi
    
    - name: Build Summary
      run: |
        echo "🎉 Tailwind CSS build completed successfully!"
        echo "📁 Output file: public/assets/css/tailwind.css"
        echo "🎨 Component classes: Included via @apply directives"
        echo "🔧 Build method: Standalone binary"
        echo "📊 Final size: $(du -h public/assets/css/tailwind.css)"
        echo ""
        echo "🚀 Deployment ready - modular CSS architecture activated"
        echo "✨ Your monolithic CSS has been replaced with sustainable build"
